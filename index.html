<!DOCTYPE html>
<html>

  <head>
    <meta charset='utf-8'>
    <meta http-equiv="X-UA-Compatible" content="chrome=1">
    <meta name="description" content="Autologin : Some little handy python scripts ">

    <link rel="stylesheet" type="text/css" media="screen" href="stylesheets/stylesheet.css">

    <title>Autologin</title>
  </head>

  <body>

    <!-- HEADER -->
    <div id="header_wrap" class="outer">
        <header class="inner">
          <a id="forkme_banner" href="https://github.com/caiqiqi/AutoLogin">View on GitHub</a>

          <h1 id="project_title">Autologin</h1>
          <h2 id="project_tagline">Some little handy python scripts </h2>

            <section id="downloads">
              <a class="zip_download_link" href="https://github.com/caiqiqi/AutoLogin/zipball/master">Download this project as a .zip file</a>
              <a class="tar_download_link" href="https://github.com/caiqiqi/AutoLogin/tarball/master">Download this project as a tar.gz file</a>
            </section>
        </header>
    </div>

    <!-- MAIN CONTENT -->
    <div id="main_content_wrap" class="outer">
      <section id="main_content" class="inner">
        <h1>
<a id="主要是用于学校研究生管理系统的自动登录" class="anchor" href="#%E4%B8%BB%E8%A6%81%E6%98%AF%E7%94%A8%E4%BA%8E%E5%AD%A6%E6%A0%A1%E7%A0%94%E7%A9%B6%E7%94%9F%E7%AE%A1%E7%90%86%E7%B3%BB%E7%BB%9F%E7%9A%84%E8%87%AA%E5%8A%A8%E7%99%BB%E5%BD%95" aria-hidden="true"><span aria-hidden="true" class="octicon octicon-link"></span></a>主要是用于学校研究生管理系统的自动登录</h1>

<p>YouTube地址：<a href="https://www.youtube.com/watch?v=K4LTgzm9G3w">https://www.youtube.com/watch?v=K4LTgzm9G3w</a> 
秒拍视频：<a href="http://weibo.com/p/230444427857313e89770690bec69367024c29">http://weibo.com/p/230444427857313e89770690bec69367024c29</a> 
心路历程: <img src="https://github.com/caiqiqi/AutoLogin/blob/master/executing-process.png" alt="心路历程"> 
登录成功页面: <img src="https://github.com/caiqiqi/AutoLogin/blob/master/loging.aspx.png" alt="登录成功界面">
已登录的默认页面: <img src="https://github.com/caiqiqi/AutoLogin/blob/master/default.aspx.png" alt="已登录的默认页面"></p>

<h2>
<a id="student-login-finalpy" class="anchor" href="#student-login-finalpy" aria-hidden="true"><span aria-hidden="true" class="octicon octicon-link"></span></a>student-login-final.py</h2>

<p>通过Chrome/Firefox的开发者工具以及Burp Suite分析登录过程的HTTP通信细节，然后用python实现对目标网站在给定学号密码情况下的自动登录。 </p>

<h2>
<a id="难点" class="anchor" href="#%E9%9A%BE%E7%82%B9" aria-hidden="true"><span aria-hidden="true" class="octicon octicon-link"></span></a>难点</h2>

<p>分析整个HTTP通信过程。实际用浏览器登录时由于有各种css/js/png文件，还有像WebResource.axd，ScriptResource.axd这种让你迷惑不知重不重要的文件。通过分析和实验，发现主要有三个HTTP请求。</p>

<p>1. 先请求登录页面 `http://gs.cqupt.edu.cn:8080/gstudent/loging.aspx?undefined` 如果已登录未退出这个session还是已登录的状态，或者登录过期这个session虽然已失效但是sessionId还在，这种情况下不会新建session，而是沿用之前的session，服务器端返回的请求中不会『Set-cookie』。如果不是以上情况，则会在这第一次请求之后服务器在返回的响应中通过『Set-cookie』发给客户端一个cookie，这个cookie的内容就是这次session的sessionId。如果直接用requests库的get/post方法，则会在headers(HTTP的请求头)中将connection字段设置为closed，这样不利用之后的请求沿用之前的cookie以保持同一次session，导致服务器在登录认证的过程中不能将之后的请求与之前的请求联系起来，最终返回302重定向到这个页面 `http://gs.cqupt.edu.cn:8080/gstudent/ReLogin.aspx?ReturnUrl=/gstudent/loging.aspx?undefined`  让用户重新登录从而登录失败。
在第一次发出的get请求后还要从返回的html页面中找出三个重要参数供后续的请求中用到。这三个参数是：登录的最后一步提交post请求时的表单里的数据'__VIEWSTATE'和'EVENTVALIDATION'字段；以及第二次get请求图片验证码时用到的`?image=124685645`类似这样的参数。</p>
<p>2. 然后请求验证码页面，即访问一个.aspx页面并带一个随机参数(这个参数并不是像有些网站一样通过前端的js文件中的Math.random()随机产生)。由于我并不知道服务器端生成这个随机参数的逻辑，于是我只能通过分析返回的html页面中找出下一步要请求的验证码页面。然后通过requests.Session.get发出请求，将得到的图片存入本地文件，然后打开这个文件用`pytesseract`这个库来将图片内容解析成文字。
</p>

<p>3. 登录的最后一步就是将之前搜集的几个重要参数加上用户名，密码，验证码post到指定的url `http://gs.cqupt.edu.cn:8080/gstudent/ReLogin.aspx?ReturnUrl=/gstudent/loging.aspx?undefined` 注意这里不是提交到这里`http://gs.cqupt.edu.cn:8080/gstudent/loging.aspx?undefined` (这里碰到过坑所以提一下)
</p>

<p>然后通过打印出当前页面的url可以看出是否已经登录了。然后就可以做任意已登录的操作了。</p>

<ul>
<li>ConfigParser:  用于从.ini文件中读取用户名和密码</li>
<li>requests: 关键库。用于进行HTTP请求(GET/POST)。可带headers(HTTP请求头)，data(POST时带的表单信息)。</li>
<li>pytesseract: 开源图像识别库。它的image_to_string()可以将一个PIL.Image包装的图片文件识别出其中的文字信息，并返回该字符串。</li>
<li>bs4.BeautifulSoup: 解析xml/html的库。这里用于查找hidden的'__VIEWSTATE' 和 'EVENTVALIDATION'。也可用lxml或者正则re。</li>
</ul>
      </section>
    </div>

    <!-- FOOTER  -->
    <div id="footer_wrap" class="outer">
      <footer class="inner">
        <p class="copyright">Autologin maintained by <a href="https://github.com/caiqiqi">caiqiqi</a></p>
        <p>Published with <a href="https://pages.github.com">GitHub Pages</a></p>
      </footer>
    </div>

    

  </body>
</html>
